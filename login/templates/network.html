<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="http://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
    <script src="http://cdn.bootcss.com/typeahead.js/0.11.1/typeahead.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-treeview@1.2.0/dist/bootstrap-treeview.min.js"></script>
    <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" rel="stylesheet">

    <style>
        body {
            font-family: helvetica neue, helvetica, liberation sans, arial, sans-serif;
        }

        #cy {
            position: absolute;
            left: 30%;
            top: 0;
            bottom: 0;
            right: 0;
            z-index: 1;
            opacity: 0.7;
        }

        #help_btn {
            display: none;
            width: 500px;
            height: 300px;
            border: 1px solid #c0c0c0;
            background: #ffffff;
            position: absolute;
            left: 50%;
            top: 20%;
        }

    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            window.cy = cytoscape({
                container: document.getElementById('cy'),
                style: [{
                    selector: 'node',
                    css: {
                        'content': 'data(name)',
                        'text-valign': 'center',
                        'color': 'white',
                        'text-outline-width': 2,
                        'text-outline-color': '#888',
                        'background-color': '#888'
                    }
                },
                    {
                        selector: 'edge',
                        css: {
                            'background-color': 'black',
                            'line-color': 'black',
                            'target-arrow-color': 'black',
                            'source-arrow-color': 'black',
                            'text-outline-color': 'black',
                            "target-arrow-shape": "triangle",
                            "target-arrow-color": "rgb(0,0,0)",
                        }
                    },
                ],
                elements: {
                    nodes: [
                        {data: {id: 'one', name: 'Cytoscape'}},
                        {data: {id: 'two', name: 'example'}},
                    ],
                    edges: [
                        {data: {source: 'one', target: 'two'}}
                    ]
                },
                layout: {name: 'cose'}
            });
        })

        var tree = []
        window.onload = function init() {
            $.ajax({
                type: "GET",
                url: "/get_json",
                success: function (res) {
                    tree = res.data.nodes
                    $('#tree').treeview({
                        data: tree,
                        highlightSelected: true,
                        multiSelect: false,
                    });
                }
            })
        }

        function load_network() {

            $.ajax({
                type: "GET",
                url: "/networks",
                data: {
                    network_id: document.getElementById('network_id').value
                },
                success: function (res) {
                    cy.destroy()
                    console.log(res.nodes)
                    window.cy = cytoscape({
                        container: document.getElementById('cy'),
                        style: res.style,
                        elements: {
                            nodes: res.nodes,
                            edges: res.edges,
                        },
                        layout: {name: 'cose'}
                    });
                    alertNode()
                    double_click_node()
                }
            })
        }

        function alertNode() {
            cy.on('onetap', 'node', function (e) {
                var node = e.target;
                document.getElementById('node_data').val()
                alert('tapped ' + node.data("name"));

            });
        }


        function double_click_node() {
            cy.on('dbltap', 'node', function (e) {
                var node = e.target;
                cy.zoom({
                    level: 1.5,
                    position: cy.getElementById(node.id).position()
                });
            });
        }

        function do_mcl() {
            $.ajax({
                type: "GET",
                url: "/do_mcl",
                success: function (res) {
                    cy.destroy()
                    console.log(res.style)
                    window.cy = cytoscape({
                        container: document.getElementById('cy'),
                        style: res.style,
                        elements: {
                            nodes: res.nodes,
                            edges: res.edges,
                        },
                        layout: {name: 'cose'}
                    });
                    alertNode()
                    double_click_node()
                }
            })
        }

        function do_coloring() {
            $.ajax({
                type: "GET",
                url: "/color",
                success: function (res) {
                    cy.destroy()
                    window.cy = cytoscape({
                        container: document.getElementById('cy'),
                        style: res.style,
                        elements: {
                            nodes: res.nodes,
                            edges: res.edges,
                        },
                        layout: {name: 'cose'}
                    });
                    cy.edges('edge').style({
                        "curve-style": "bezier",
                        "target-arrow-shape": "triangle"
                    })
                    alertNode()
                    double_click_node()
                }
            })
        }


    </script>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
<!-- container section start -->
<section id="container" class="">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'proteins' %}">PlaqueMS</a>
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="{% url 'proteins' %}">proteins</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'plot' %}">visualization</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'cy' %}">networks</a>
            </li>
        </ul>
    </div>
</section>
<div class="col-sm-4">
    <section class="panel">
        <div class="panel-heading">
            please select a network:
        </div>
        <p>
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseWidthExample" aria-expanded="false" aria-controls="collapseWidthExample">
                information
            </button>
        </p>
        <div>
            <div class="collapse collapse-horizontal" id="collapseWidthExample">
                <div class="card card-body" style="width: 300px;" id="node_data">
                    呜呜呜呜困死了好烦
                </div>
            </div>
        </div>
        <dialog id="dialog">
            <div>dialog</div>
            <button id="btn-close">close</button>
        </dialog>

        <button id="btn-open">how to operate cytoscape</button>

        <button id="downloadpng" onclick="downLoadImg()">download image</button>

        <select id="network_id" class="form-control form-control-placeholder">
            <option value="n1">gu_core_filtered_directed_network</option>
            <option value="n2">gu_periphery_filtered_directed_network</option>
            <option value="n3">nacl_core_filtered_directed_network</option>
            <option value="n4">nacl_periphery_filtered_directed_network</option>
            <option value="n5">sds_core_filtered_directed_network</option>
            <option value="n6">sds_periphery_filtered_directed_network</option>
        </select>
        <br><br><br><br><br>
        <button type="submit" onclick="load_network()">show network</button>
        <button type="submit" onclick="do_mcl()">do cluster</button>
        <br>
        <button type="submit" onclick="do_coloring()">do coloring</button>
        <div class="panel-heading">
            please select a network coloring file:
        </div>
        <div id="tree"></div>
    </section>
</div>
<div id="cy"></div>
</body>
<script>

    var btnOpen = document.querySelector("#btn-open");
    var btnClose = document.querySelector("#btn-close");
    var dialog = document.querySelector("#dialog");

    // 打开弹窗
    btnOpen.addEventListener("click", function () {
        dialog.show();
    });

    // 关闭弹窗
    btnClose.addEventListener("click", function () {
        dialog.close();
    });

    function downLoadImg() {
        var text = window.cy.png({'output': 'blob'});
        console.log(text)
        var name = "PlaqueMS.png";
        var type = "image/png";
        var file = new Blob([text], {type: type});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(file);
        a.style.display = 'none';
        a.download = 'PlaqueMS.png';
        document.body.appendChild(a);
        a.click();
    }

</script>
</html>
